name: CI/CD –¥–ª—è SmartTaskManager

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    name: üî® –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
      run: |
        echo "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:"
        ls -la
        echo ""
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ src/:"
        ls -la src/ || echo "–ü–∞–ø–∫–∞ src/ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        echo ""
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ tests/:"
        ls -la tests/ || echo "–ü–∞–ø–∫–∞ tests/ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET 8
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: üì¶ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: |
        # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã
        echo "–ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞..."
        find . -name "*.csproj" -type f | head -10
        
        # –ü—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
        echo "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
        dotnet restore || echo "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"

    - name: üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
      run: |
        echo "–ü–æ–∏—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞..."
        MAIN_PROJ=$(find . -name "*.csproj" -type f | grep -v "Test" | head -1)
        
        if [ -n "$MAIN_PROJ" ]; then
          echo "–°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞: $MAIN_PROJ"
          dotnet build "$MAIN_PROJ" --configuration Release
        else
          echo "–û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ"
          dotnet build --configuration Release
        fi

    - name: üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
      run: |
        echo "–ü–æ–∏—Å–∫ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤..."
        TEST_PROJ=$(find . -name "*.csproj" -type f | grep -i "test" | head -1)
        
        if [ -n "$TEST_PROJ" ]; then
          echo "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤: $TEST_PROJ"
          dotnet test "$TEST_PROJ" --verbosity normal
        else
          echo "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
          echo "–ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
        fi

    - name: üìä –û—Ç—á–µ—Ç
      if: always()
      run: |
        echo "========================================"
        echo "CI/CD –í–´–ü–û–õ–ù–ï–ù"
        echo "–°—Ç–∞—Ç—É—Å: ${{ job.status }}"
        echo "–í–µ—Ç–∫–∞: ${{ github.ref }}"
        echo "–ö–æ–º–º–∏—Ç: ${{ github.sha }}"
        echo "–í—Ä–µ–º—è: $(date)"
        echo "========================================"