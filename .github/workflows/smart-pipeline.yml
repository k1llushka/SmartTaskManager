name: üß† –£–º–Ω—ã–π –ø–∞–π–ø–ª–∞–Ω Task Manager

on:
  push:
    branches: [main, develop, feature/**]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 6 * * 1-5'  # –ó–∞–ø—É—Å–∫ –≤ 6 —É—Ç—Ä–∞ –ø–æ –±—É–¥–Ω—è–º

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'src/SmartTaskManager'
  TEST_PATH: 'tests/SmartTaskManager.Tests'

jobs:
  # –î–∂–æ–±–∞ 1: –£–º–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
  smart-setup:
    name: ‚ö° –£–º–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: üíæ –ö—ç—à–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: ${{ runner.os }}-nuget-

    - name: üíæ –ö—ç—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–±–æ—Ä–∫–∏
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.PROJECT_PATH }}/bin
          ${{ env.PROJECT_PATH }}/obj
        key: ${{ runner.os }}-build-${{ hashFiles('**/*.cs') }}

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üì¶ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: dotnet restore

    - name: üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
      id: changes
      uses: dorny/paths-filter@v2
      with:
        filters: |
          src:
            - 'src/**'
          tests:
            - 'tests/**'
          docs:
            - 'docs/**'

    outputs:
      src: ${{ steps.changes.outputs.src }}
      tests: ${{ steps.changes.outputs.tests }}
      docs: ${{ steps.changes.outputs.docs }}

  # –î–∂–æ–±–∞ 2: –£—Å–ª–æ–≤–Ω–∞—è —Å–±–æ—Ä–∫–∞
  conditional-build:
    name: üèóÔ∏è –£—Å–ª–æ–≤–Ω–∞—è —Å–±–æ—Ä–∫–∞
    needs: smart-setup
    runs-on: ubuntu-latest

    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ src –∏–ª–∏ —ç—Ç–æ main –≤–µ—Ç–∫–∞
    if: needs.smart-setup.outputs.src == 'true' || github.ref == 'refs/heads/main'

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üèóÔ∏è –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
      run: |
        dotnet restore ${{ env.PROJECT_PATH }}
        dotnet build ${{ env.PROJECT_PATH }} --configuration Release

    - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —Å–±–æ—Ä–∫–∏
      uses: actions/upload-artifact@v4
      with:
        name: app-build
        path: ${{ env.PROJECT_PATH }}/bin/Release/net8.0/
        retention-days: 7

  # –î–∂–æ–±–∞ 3: –£–º–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  smart-testing:
    name: üß™ –£–º–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    needs: smart-setup
    runs-on: ubuntu-latest

    strategy:
      matrix:
        test-type: [unit, integration]

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üß™ –ó–∞–ø—É—Å–∫–∞–µ–º unit-—Ç–µ—Å—Ç—ã
      if: matrix.test-type == 'unit'
      run: |
        dotnet restore ${{ env.TEST_PATH }}
        dotnet test ${{ env.TEST_PATH }} --filter "Category=Unit" --verbosity normal

    - name: üîó –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
      if: matrix.test-type == 'integration' && github.ref == 'refs/heads/main'
      run: |
        dotnet restore ${{ env.TEST_PATH }}
        dotnet test ${{ env.TEST_PATH }} --filter "Category=Integration" --verbosity normal

    - name: üìä –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç –ø–æ–∫—Ä—ã—Ç–∏—è
      if: always()
      run: |
        echo "–û—Ç—á–µ—Ç –ø–æ–∫—Ä—ã—Ç–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è ${{ matrix.test-type }} —Ç–µ—Å—Ç–æ–≤"

  # –î–∂–æ–±–∞ 4: –£—Å–ª–æ–≤–Ω—ã–π –¥–µ–ø–ª–æ–π
  conditional-deploy:
    name: üöÄ –£—Å–ª–æ–≤–Ω—ã–π –¥–µ–ø–ª–æ–π
    needs: [conditional-build, smart-testing]
    runs-on: ubuntu-latest

    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è main –≤–µ—Ç–∫–∏ –∏ –µ—Å–ª–∏ –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏
    if: github.ref == 'refs/heads/main' && needs.smart-testing.result == 'success'

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üì¶ –ü—É–±–ª–∏–∫—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      run: |
        dotnet restore ${{ env.PROJECT_PATH }}
        dotnet publish ${{ env.PROJECT_PATH }} -c Release -o ./publish --self-contained false

    - name: üìÅ –°–æ–∑–¥–∞–µ–º —Ä–∞–∑–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
      run: |
        # Production –ø–∞–∫–µ—Ç
        mkdir -p packages/production
        cp -r ./publish/* packages/production/
        echo "PRODUCTION_BUILD=true" >> packages/production/build-info.txt
        echo "BUILD_DATE=$(date)" >> packages/production/build-info.txt
        
        # Staging –ø–∞–∫–µ—Ç (—Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π)
        mkdir -p packages/staging
        cp -r ./publish/* packages/staging/
        echo "STAGING_BUILD=true" >> packages/staging/build-info.txt
        echo "BUILD_DATE=$(date)" >> packages/staging/build-info.txt
        echo "BRANCH=${{ github.ref }}" >> packages/staging/build-info.txt

    - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞–∫–µ—Ç—ã
      uses: actions/upload-artifact@v4
      with:
        name: deployment-packages
        path: packages/
        retention-days: 30

  # –î–∂–æ–±–∞ 5: –£–º–Ω—ã–π –æ—Ç—á–µ—Ç
  smart-report:
    name: üìä –£–º–Ω—ã–π –æ—Ç—á–µ—Ç
    needs: [smart-setup, conditional-build, smart-testing, conditional-deploy]
    runs-on: ubuntu-latest

    steps:
    - name: üìù –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
      run: |
        echo "========================================"
        echo "üß† –£–ú–ù–´–ô –û–¢–ß–ï–¢ –û –í–´–ü–û–õ–ù–ï–ù–ò–ò"
        echo "========================================"
        echo ""
        echo "  –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–ë–û–†–ö–ï: "
        echo "  ‚óè –í–µ—Ç–∫–∞: ${{ github.ref }}"
        echo "  ‚óè –ö–æ–º–º–∏—Ç: ${{ github.sha }}"
        echo "  ‚óè –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä: ${{ github.actor }}"
        echo ""
        echo "  –†–ï–ó–£–õ–¨–¢–ê–¢–´ –≠–¢–ê–ü–û–í: "
        echo "  ‚óè –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞: ${{ needs.smart-setup.result }}"
        echo "  ‚óè –°–±–æ—Ä–∫–∞: ${{ needs.conditional-build.result }}"
        echo "  ‚óè –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${{ needs.smart-testing.result }}"
        echo "  ‚óè –î–µ–ø–ª–æ–π: ${{ needs.conditional-deploy.result }}"
        echo ""
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–µ—Ç–∫–∏
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          echo "  üìå –†–ï–ñ–ò–ú: –ü–†–û–î–ê–ö–®–ï–ù"
          echo "  ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–ª–∏–∑—É!"
        elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
          echo "  üîß –†–ï–ñ–ò–ú: –†–ê–ó–†–ê–ë–û–¢–ö–ê"
          echo "  ‚ö†Ô∏è –¢–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
        else
          echo "  üåø –†–ï–ñ–ò–ú: –§–ò–ß–ê-–í–ï–¢–ö–ê"
          echo "  üöß –í –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏"
        fi
        
        echo ""
        echo "  –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: $(date)"
        echo "========================================"

    - name: üîî –£—Å–ª–æ–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      if: always()
      run: |
        if [ "${{ needs.smart-testing.result }}" == "failure" ]; then
          echo "‚ùå –¢–ï–°–¢–´ –ù–ï –ü–†–û–®–õ–ò! –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞!"
        elif [ "${{ github.ref }}" == "refs/heads/main" ] && [ "${{ needs.conditional-deploy.result }}" == "success" ]; then
          echo "üéâ –£–°–ü–ï–®–ù–´–ô –†–ï–õ–ò–ó! –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!"
        else
          echo "‚úÖ –í—Å–µ —ç—Ç–∞–ø—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
        fi