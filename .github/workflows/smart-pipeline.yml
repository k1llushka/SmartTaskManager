name: ğŸ§  Ğ£Ğ¼Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ½ Task Manager

on:
  push:
    branches: [main, develop, 'feature/**']
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 6 * * 1-5'  # Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ² 6 ÑƒÑ‚Ñ€Ğ° Ğ¿Ğ¾ Ğ±ÑƒĞ´Ğ½ÑĞ¼

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'src/SmartTaskManager'
  TEST_PATH: 'tests/SmartTaskManager.Tests'
  PROJECT_NAME: 'SmartTaskManager'

jobs:
  # Ğ”Ğ¶Ğ¾Ğ±Ğ° 1: Ğ£Ğ¼Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼
  smart-setup:
    name: âš¡ Ğ£Ğ¼Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ°
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ĞºĞ¾Ğ´
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹

    - name: ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
      run: |
        echo "Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ: $(pwd)"
        echo "Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ:"
        ls -la
        echo ""
        echo "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿ÑƒÑ‚ÑŒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°: ./${{ env.PROJECT_PATH }}"
        if [ -d "./${{ env.PROJECT_PATH }}" ]; then
          echo "âœ… ĞŸĞ°Ğ¿ĞºĞ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°"
          ls -la "./${{ env.PROJECT_PATH }}/"
        else
          echo "âŒ ĞŸĞ°Ğ¿ĞºĞ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° ĞĞ• Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°"
          echo "Ğ˜Ñ‰ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ .csproj..."
          find . -name "*.csproj" -type f | head -10
        fi

    - name: âš™ï¸ Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ’¾ ĞšÑÑˆĞ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ NuGet
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: ğŸ’¾ ĞšÑÑˆĞ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ ÑĞ±Ğ¾Ñ€ĞºĞ¸
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.PROJECT_PATH }}/bin
          ${{ env.PROJECT_PATH }}/obj
          ${{ env.TEST_PATH }}/bin
          ${{ env.TEST_PATH }}/obj
        key: ${{ runner.os }}-build-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-build-

    - name: ğŸ“¦ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
      run: |
        echo "ğŸ” Ğ˜Ñ‰ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°..."
        # Ğ˜Ñ‰ĞµĞ¼ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
        MAIN_PROJ=$(find ./${{ env.PROJECT_PATH }} -name "*.csproj" -type f | head -1)
        if [ -n "$MAIN_PROJ" ]; then
          echo "ğŸ“¦ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚: $MAIN_PROJ"
          dotnet restore "$MAIN_PROJ"
        else
          echo "âŒ Ğ¤Ğ°Ğ¹Ğ» Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² ${{ env.PROJECT_PATH }}"
          echo "ğŸ“¦ ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñ‹ Ğ² Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸..."
          dotnet restore
        fi
        
        # Ğ˜Ñ‰ĞµĞ¼ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
        TEST_PROJ=$(find ./${{ env.TEST_PATH }} -name "*.csproj" -type f | head -1)
        if [ -n "$TEST_PROJ" ]; then
          echo "ğŸ§ª Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚: $TEST_PROJ"
          dotnet restore "$TEST_PROJ"
        fi

    - name: ğŸ” ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
      id: changes
      uses: dorny/paths-filter@v2
      with:
        base: ${{ github.base_ref || 'main' }}
        filters: |
          src:
            - '${{ env.PROJECT_PATH }}/**'
          tests:
            - '${{ env.TEST_PATH }}/**'
          docs:
            - 'docs/**'
          config:
            - '**.json'
            - '**.yml'
            - '**.yaml'
            - '**.config'

    outputs:
      src_changed: ${{ steps.changes.outputs.src }}
      tests_changed: ${{ steps.changes.outputs.tests }}
      docs_changed: ${{ steps.changes.outputs.docs }}
      config_changed: ${{ steps.changes.outputs.config }}

  # Ğ”Ğ¶Ğ¾Ğ±Ğ° 2: Ğ£ÑĞ»Ğ¾Ğ²Ğ½Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºĞ°
  conditional-build:
    name: ğŸ—ï¸ Ğ£ÑĞ»Ğ¾Ğ²Ğ½Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºĞ°
    needs: smart-setup
    runs-on: ubuntu-latest

    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞ±Ğ¾Ñ€ĞºÑƒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ±Ñ‹Ğ»Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ² src Ğ¸Ğ»Ğ¸ ÑÑ‚Ğ¾ main Ğ²ĞµÑ‚ĞºĞ°
    if: needs.smart-setup.outputs.src_changed == 'true' || github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ĞºĞ¾Ğ´
      uses: actions/checkout@v4

    - name: âš™ï¸ Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ—ï¸ Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
      run: |
        # ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ñ„Ğ°Ğ¹Ğ» Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
        PROJECT_FILE=$(find ./${{ env.PROJECT_PATH }} -name "*.csproj" -type f | head -1)
        if [ -z "$PROJECT_FILE" ]; then
          echo "âŒ Ğ¤Ğ°Ğ¹Ğ» Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
          exit 1
        fi
        
        echo "ğŸ”¨ Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚: $PROJECT_FILE"
        dotnet build "$PROJECT_FILE" --configuration Release --no-restore
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ ÑĞ±Ğ¾Ñ€ĞºĞ¸
        if [ $? -eq 0 ]; then
          echo "âœ… Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ°"
        else
          echo "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ±Ğ¾Ñ€ĞºĞ¸"
          exit 1
        fi

    - name: ğŸ“ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ ÑĞ±Ğ¾Ñ€ĞºĞ¸
      run: |
        BUILD_PATH="./${{ env.PROJECT_PATH }}/bin/Release/net8.0"
        echo "ğŸ“ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ²: $BUILD_PATH"
        
        if [ -d "$BUILD_PATH" ]; then
          echo "âœ… ĞŸĞ°Ğ¿ĞºĞ° ÑĞ±Ğ¾Ñ€ĞºĞ¸ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚"
          ls -la "$BUILD_PATH/"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
          MAIN_DLL=$(find "$BUILD_PATH" -name "*.dll" -type f | head -1)
          if [ -n "$MAIN_DLL" ]; then
            echo "âœ… ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ DLL Ğ½Ğ°Ğ¹Ğ´ĞµĞ½: $(basename $MAIN_DLL)"
          else
            echo "âš ï¸ ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ DLL Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
          fi
        else
          echo "âŒ ĞŸĞ°Ğ¿ĞºĞ° ÑĞ±Ğ¾Ñ€ĞºĞ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°"
        fi

    - name: ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚ ÑĞ±Ğ¾Ñ€ĞºĞ¸
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: app-build
        path: ${{ env.PROJECT_PATH }}/bin/Release/
        retention-days: 7

  # Ğ”Ğ¶Ğ¾Ğ±Ğ° 3: Ğ£Ğ¼Ğ½Ğ¾Ğµ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
  smart-testing:
    name: ğŸ§ª Ğ£Ğ¼Ğ½Ğ¾Ğµ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    needs: smart-setup
    runs-on: ubuntu-latest

    strategy:
      matrix:
        test-type: [unit, integration]
        include:
          - test-type: unit
            filter: "Category=Unit"
            runs-on: ubuntu-latest
          - test-type: integration
            filter: "Category=Integration"
            runs-on: ubuntu-latest

    # Ğ”Ğ»Ñ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ñ… Ñ‚ĞµÑÑ‚Ğ¾Ğ² - Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ° main Ğ¸Ğ»Ğ¸ ĞµÑĞ»Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¸ÑÑŒ Ñ‚ĞµÑÑ‚Ñ‹
    if: |
      (matrix.test-type == 'unit') ||
      (matrix.test-type == 'integration' && 
       (github.ref == 'refs/heads/main' || 
        needs.smart-setup.outputs.tests_changed == 'true'))

    steps:
    - name: ğŸ“¥ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ĞºĞ¾Ğ´
      uses: actions/checkout@v4

    - name: âš™ï¸ Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ” ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
      id: find-test-project
      run: |
        TEST_PROJ=$(find ./${{ env.TEST_PATH }} -name "*.csproj" -type f | head -1)
        if [ -n "$TEST_PROJ" ]; then
          echo "âœ… ĞĞ°Ğ¹Ğ´ĞµĞ½ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚: $TEST_PROJ"
          echo "test_project=$TEST_PROJ" >> $GITHUB_OUTPUT
        else
          echo "âŒ Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
          exit 1
        fi

    - name: ğŸ§ª Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ${{ matrix.test-type }}-Ñ‚ĞµÑÑ‚Ñ‹
      run: |
        echo "ğŸ§ª Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ${{ matrix.test-type }} Ñ‚ĞµÑÑ‚Ñ‹ Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ¼: ${{ matrix.filter }}"
        dotnet test "${{ steps.find-test-project.outputs.test_project }}" \
          --filter "${{ matrix.filter }}" \
          --verbosity normal \
          --logger "trx;LogFileName=${{ matrix.test-type }}-results.trx" \
          --results-directory ./TestResults \
          --no-restore

    - name: ğŸ“Š Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ñ‚ĞµÑÑ‚Ğ¾Ğ²
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.test-type }}
        path: |
          TestResults/
          **/*.trx
        retention-days: 30

    - name: ğŸ“ˆ Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ
      if: always() && matrix.test-type == 'unit'
      run: |
        echo "ğŸ“Š Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ Ğ´Ğ»Ñ unit-Ñ‚ĞµÑÑ‚Ğ¾Ğ²..."
        # Ğ’ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ¿Ğ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½Ğµ Ğ·Ğ´ĞµÑÑŒ Ğ±Ñ‹Ğ»Ğ° Ğ±Ñ‹ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°
        echo "ĞÑ‚Ñ‡ĞµÑ‚ Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ´Ğ»Ñ ${{ matrix.test-type }}-Ñ‚ĞµÑÑ‚Ğ¾Ğ²" > coverage-report.txt
        echo "ĞŸĞ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ ĞºĞ¾Ğ´Ğ°: 85%" >> coverage-report.txt
        echo "Ğ”Ğ°Ñ‚Ğ°: $(date)" >> coverage-report.txt

    - name: ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ
      if: always() && matrix.test-type == 'unit'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage-report.txt
        retention-days: 30

  # Ğ”Ğ¶Ğ¾Ğ±Ğ° 4: Ğ£ÑĞ»Ğ¾Ğ²Ğ½Ñ‹Ğ¹ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹
  conditional-deploy:
    name: ğŸš€ Ğ£ÑĞ»Ğ¾Ğ²Ğ½Ñ‹Ğ¹ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹
    needs: [conditional-build, smart-testing]
    runs-on: ubuntu-latest

    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ main Ğ²ĞµÑ‚ĞºĞ¸ Ğ¸ ĞµÑĞ»Ğ¸ Ğ²ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¸
    if: |
      github.ref == 'refs/heads/main' &&
      needs.conditional-build.result == 'success' &&
      (needs.smart-testing.result == 'success' || needs.smart-testing.result == 'skipped')

    steps:
    - name: ğŸ“¥ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ĞºĞ¾Ğ´
      uses: actions/checkout@v4

    - name: âš™ï¸ Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ“¦ ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ
      run: |
        # ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ñ„Ğ°Ğ¹Ğ» Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
        PROJECT_FILE=$(find ./${{ env.PROJECT_PATH }} -name "*.csproj" -type f | head -1)
        if [ -z "$PROJECT_FILE" ]; then
          echo "âŒ Ğ¤Ğ°Ğ¹Ğ» Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
          exit 1
        fi
        
        echo "ğŸš€ ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ: $PROJECT_FILE"
        dotnet publish "$PROJECT_FILE" \
          -c Release \
          -o ./publish \
          --self-contained false \
          --no-restore
        
        echo "âœ… ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°"
        echo "ğŸ“ Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸ publish:"
        ls -la ./publish/

    - name: ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ Ğ¿Ğ°ĞºĞµÑ‚Ñ‹
      run: |
        echo "ğŸ“¦ Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ°ĞºĞµÑ‚Ñ‹ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğ¹..."
        
        # Production Ğ¿Ğ°ĞºĞµÑ‚
        mkdir -p packages/production
        cp -r ./publish/* packages/production/
        echo "PRODUCTION_BUILD=true" > packages/production/build-info.txt
        echo "BUILD_DATE=$(date)" >> packages/production/build-info.txt
        echo "VERSION=1.0.0" >> packages/production/build-info.txt
        echo "COMMIT=${{ github.sha }}" >> packages/production/build-info.txt
        
        # Staging Ğ¿Ğ°ĞºĞµÑ‚ (Ñ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹)
        mkdir -p packages/staging
        cp -r ./publish/* packages/staging/
        echo "STAGING_BUILD=true" > packages/staging/build-info.txt
        echo "BUILD_DATE=$(date)" >> packages/staging/build-info.txt
        echo "BRANCH=${{ github.ref }}" >> packages/staging/build-info.txt
        echo "COMMIT=${{ github.sha }}" >> packages/staging/build-info.txt
        echo "AUTHOR=${{ github.actor }}" >> packages/staging/build-info.txt
        
        echo "âœ… ĞŸĞ°ĞºĞµÑ‚Ñ‹ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹:"
        ls -la packages/
        echo ""
        echo "ğŸ“„ Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ°ĞºĞµÑ‚Ğ°Ñ…:"
        cat packages/production/build-info.txt
        echo "---"
        cat packages/staging/build-info.txt

    - name: ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¿Ğ°ĞºĞµÑ‚Ñ‹
      uses: actions/upload-artifact@v4
      with:
        name: deployment-packages
        path: packages/
        retention-days: 30

    - name: ğŸ·ï¸ Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ‚ĞµĞ³ Ñ€ĞµĞ»Ğ¸Ğ·Ğ°
      if: success()
      run: |
        echo "ğŸ·ï¸ Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ‚ĞµĞ³ Ğ´Ğ»Ñ Ñ€ĞµĞ»Ğ¸Ğ·Ğ°..."
        VERSION="v1.0.0-$(date +%Y%m%d-%H%M%S)"
        echo "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ñ‚ĞµĞ³: $VERSION"
        echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV

  # Ğ”Ğ¶Ğ¾Ğ±Ğ° 5: Ğ£Ğ¼Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚
  smart-report:
    name: ğŸ“Š Ğ£Ğ¼Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚
    needs: [smart-setup, conditional-build, smart-testing, conditional-deploy]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: ğŸ“ Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
      run: |
        echo "========================================"
        echo "ğŸ§  Ğ£ĞœĞĞ«Ğ™ ĞĞ¢Ğ§Ğ•Ğ¢ Ğ Ğ’Ğ«ĞŸĞĞ›ĞĞ•ĞĞ˜Ğ˜"
        echo "========================================"
        echo ""
        echo "ğŸ“‹ Ğ˜ĞĞ¤ĞĞ ĞœĞĞ¦Ğ˜Ğ¯ Ğ Ğ¡Ğ‘ĞĞ ĞšĞ•: "
        echo "  â— Ğ’ĞµÑ‚ĞºĞ°: ${{ github.ref }}"
        echo "  â— ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚: ${{ github.sha }}"
        echo "  â— Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ñ‚Ğ¾Ñ€: ${{ github.actor }}"
        echo "  â— Ğ Ğ°Ğ±Ğ¾Ñ‡Ğ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ: ${{ github.workspace }}"
        echo "  â— Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ: ${{ github.event_name }}"
        echo ""
        echo "ğŸ“Š Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢Ğ« Ğ­Ğ¢ĞĞŸĞĞ’: "
        echo "  âš¡ ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ°: ${{ needs.smart-setup.result }}"
        echo "  ğŸ—ï¸ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ°: ${{ needs.conditional-build.result }}"
        echo "  ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: ${{ needs.smart-testing.result }}"
        echo "  ğŸš€ Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹: ${{ needs.conditional-deploy.result }}"
        echo ""
        echo "ğŸ” Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ¯: "
        echo "  ğŸ“ Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´: ${{ needs.smart-setup.outputs.src_changed }}"
        echo "  ğŸ§ª Ğ¢ĞµÑÑ‚Ñ‹: ${{ needs.smart-setup.outputs.tests_changed }}"
        echo "  ğŸ“– Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ: ${{ needs.smart-setup.outputs.docs_changed }}"
        echo "  âš™ï¸ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ: ${{ needs.smart-setup.outputs.config_changed }}"
        echo ""
        
        # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ğ²ĞµÑ‚ĞºĞ¸
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          echo "ğŸ¯ Ğ Ğ•Ğ–Ğ˜Ğœ: ĞŸĞ ĞĞ”ĞĞšĞ¨Ğ•Ğ"
          echo "  âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ Ğº Ñ€ĞµĞ»Ğ¸Ğ·Ñƒ!"
          echo "  ğŸ·ï¸ Ğ’ĞµÑ€ÑĞ¸Ñ: ${{ env.RELEASE_VERSION || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ°' }}"
        elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
          echo "ğŸ”§ Ğ Ğ•Ğ–Ğ˜Ğœ: Ğ ĞĞ—Ğ ĞĞ‘ĞĞ¢ĞšĞ"
          echo "  âš ï¸ Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"
          echo "  ğŸ“ˆ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ½Ğ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ñ Ñ„Ğ¸Ñ‡"
        elif [[ "${{ github.ref }}" == refs/heads/feature/* ]]; then
          echo "ğŸŒ¿ Ğ Ğ•Ğ–Ğ˜Ğœ: Ğ¤Ğ˜Ğ§Ğ-Ğ’Ğ•Ğ¢ĞšĞ"
          echo "  ğŸš§ Ğ’ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞµ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸"
          echo "  ğŸ”¬ Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ ĞºĞ¾Ğ´-Ñ€ĞµĞ²ÑŒÑ"
        else
          echo "â“ Ğ Ğ•Ğ–Ğ˜Ğœ: ĞĞ•Ğ˜Ğ—Ğ’Ğ•Ğ¡Ğ¢ĞĞ«Ğ™"
          echo "  ğŸ“ ${{ github.ref }}"
        fi
        
        echo ""
        echo "ğŸ• Ğ¡Ñ‚Ğ°Ñ€Ñ‚: ${{ github.event.head_commit.timestamp || 'Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾' }}"
        echo "ğŸ• Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        echo "========================================"

    - name: ğŸ”” Ğ£ÑĞ»Ğ¾Ğ²Ğ½Ñ‹Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ
      if: always()
      run: |
        echo "ğŸ”” Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡ Ğ’Ğ«ĞŸĞĞ›ĞĞ•ĞĞ˜Ğ¯:"
        echo ""
        
        if [ "${{ needs.smart-testing.result }}" == "failure" ]; then
          echo "âŒ ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ•: Ğ¢Ğ•Ğ¡Ğ¢Ğ« ĞĞ• ĞŸĞ ĞĞ¨Ğ›Ğ˜!"
          echo "   Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ½ĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾Ğµ Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ°!"
          echo "   ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ñ‚ĞµÑÑ‚Ğ¾Ğ² Ğ² Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ°Ñ…."
        elif [ "${{ needs.conditional-build.result }}" == "failure" ]; then
          echo "âŒ ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ•: ĞĞ¨Ğ˜Ğ‘ĞšĞ Ğ¡Ğ‘ĞĞ ĞšĞ˜!"
          echo "   ĞŸÑ€Ğ¾ĞµĞºÑ‚ Ğ½Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ."
          echo "   ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ ÑĞ¸Ğ½Ñ‚Ğ°ĞºÑĞ¸Ñ Ğ¸ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸."
        elif [ "${{ github.ref }}" == "refs/heads/main" ] && [ "${{ needs.conditional-deploy.result }}" == "success" ]; then
          echo "ğŸ‰ Ğ£Ğ¡ĞŸĞ•Ğ¥: Ğ Ğ•Ğ›Ğ˜Ğ— Ğ’Ğ«ĞŸĞĞ›ĞĞ•Ğ!"
          echo "   âœ… ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ¾"
          echo "   âœ… Ğ’ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ñ‹"
          echo "   âœ… ĞŸĞ°ĞºĞµÑ‚Ñ‹ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹ Ğ¸ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹ Ğº Ğ´ĞµĞ¿Ğ»Ğ¾Ñ"
          echo "   ğŸ·ï¸ Ğ’ĞµÑ€ÑĞ¸Ñ: ${{ env.RELEASE_VERSION || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ°' }}"
        elif [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Ğ’Ğ¡Ğ• Ğ­Ğ¢ĞĞŸĞ« Ğ’Ğ«ĞŸĞĞ›ĞĞ•ĞĞ« Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ"
          echo "   Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ Ğ´Ğ»Ñ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ³Ğ¾ ÑˆĞ°Ğ³Ğ°"
        else
          echo "âš ï¸ Ğ§ĞĞ¡Ğ¢Ğ˜Ğ§ĞĞ«Ğ™ Ğ£Ğ¡ĞŸĞ•Ğ¥ Ğ˜Ğ›Ğ˜ ĞŸĞ ĞĞŸĞ£Ğ¡Ğš Ğ­Ğ¢ĞĞŸĞĞ’"
          echo "   ĞĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ ÑÑ‚Ğ°Ğ¿Ñ‹ Ğ±Ñ‹Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ñ‹ Ğ¿Ğ¾ ÑƒÑĞ»Ğ¾Ğ²Ğ¸ÑĞ¼"
          echo "   ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ»Ğ¾Ğ³Ğ¸ Ğ´Ğ»Ñ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹"
        fi

    - name: ğŸ“¤ Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²
      if: always()
      run: |
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ JSON Ñ„Ğ°Ğ¹Ğ» Ñ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°Ğ¼Ğ¸ Ğ´Ğ»Ñ Ğ´Ğ°Ğ»ÑŒĞ½ĞµĞ¹ÑˆĞµĞ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
        cat > pipeline-results.json << EOF
        {
          "pipeline": "Smart Task Manager CI/CD",
          "timestamp": "$(date -Iseconds)",
          "repository": "${{ github.repository }}",
          "ref": "${{ github.ref }}",
          "sha": "${{ github.sha }}",
          "actor": "${{ github.actor }}",
          "results": {
            "smart_setup": "${{ needs.smart-setup.result }}",
            "conditional_build": "${{ needs.conditional-build.result }}",
            "smart_testing": "${{ needs.smart-testing.result }}",
            "conditional_deploy": "${{ needs.conditional-deploy.result }}"
          },
          "changes": {
            "src": "${{ needs.smart-setup.outputs.src_changed }}",
            "tests": "${{ needs.smart-setup.outputs.tests_changed }}",
            "docs": "${{ needs.smart-setup.outputs.docs_changed }}",
            "config": "${{ needs.smart-setup.outputs.config_changed }}"
          },
          "environment": "${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}"
        }
        EOF
        
        echo "ğŸ“„ Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ² pipeline-results.json"
        cat pipeline-results.json

    - name: ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pipeline-report
        path: |
          pipeline-results.json
        retention-days: 90